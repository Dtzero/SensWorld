<!DOCTYPE HTML>
<html lang="zh-hans">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="renderer" content="webkit" />
    <title>Sens World</title>
    <link rel="stylesheet" href="static/css/index.css" />
</head>
<body>
<div class="preload-block">
    <img src="http://i2.muimg.com/4851/24d05b63045ffd02.jpg" />
</div>

<div class="welcome-block j-welcome-block">
    <div class="welcome-block-main rel">
        <div class="welcome-box-center j-welcome-box-center">
            <span class="welcome-text j-welcome-text line1">额，趁现在资源还在加载</span>
            <span class="welcome-text j-welcome-text line2">我先给你讲一个冷笑话</span>
            <span class="welcome-text j-welcome-text line3">有一个叫程思序的人</span>
            <span class="welcome-text j-welcome-text line4">整天思程序</span>
            <span class="welcome-text j-welcome-text line5">．．．．．．</span>
            <span class="welcome-text j-welcome-text line6">好尴尬，我们来看看资源加载完没有</span>
            <span class="welcome-text j-welcome-text line7 fail">哇塞，居然没加载完！</span>
            <span class="welcome-text j-welcome-text line7 success">哇塞，已经加载完了！</span>
            <span class="welcome-text j-welcome-text line8 fail">不管了，直接开始吧！</span>
            <span class="welcome-text j-welcome-text line8 success">那我们就立刻开始吧！</span>
            <span class="welcome-text-line">|</span>
            <div class="welcome-btn-start"></div>
        </div>

        <div class="welcome-box-btn j-welcome-box-btn hide">
            <input placeholder="" type="checkbox">
            <span class="welcome-btn"></span>
            <p class="welcome-text-tip">接下来记得使用滚轮哟</p>
        </div>
    </div>
</div>
<div id="j-wrapper-block-back" class="wrapper-block">
    <div id="j-stage-block-back" class="stage-block-back">
        <img src="http://i2.muimg.com/4851/24d05b63045ffd02.jpg" ondragstart="return false" class="wrapper-img"/>
        <canvas id="wrapper-cvs" class="wrapper-cvs"></canvas>
    </div>
</div>
<div class="wrapper-block-main j-wrapper-block-main">
    <div class="stage-block-main j-stage-block-main">
        <div class="stage-box-earth j-stage-box-earth">
            <img src="http://i2.muimg.com/4851/30acc09acf1e627f.png" alt="" class="j-stage-img-earth">
        </div>
        <div class="wrapper-box-link">呵呵</div>
    </div>
</div>

<script src="http://libs.baidu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="static/js/MusicVisualizer.js"></script>
<script src="static/js/makeSky.js"></script>
<script src="static/js/breakImg.js"></script>
<script>
    var Cookie = (function () {
        function setCookie(name, value, day) {
            var oDate = new Date();
            oDate.setDate(oDate.getDate() + day);
            document.cookie = name + '=' + value + ';expires=' + oDate;
        }
        function delCookie(name) {
            setCookie(name, 1, -1);
        }
        function getCookie(name) {
            var arr = document.cookie.split('; ');
            for(var i = 0; i < arr.length; i++) {
                var arrName = arr[i].split('=');
                if(arrName[0] == name) {
                    return arrName[1];
                }
            }
            return '';
        }
        return {
            set: setCookie,
            del: delCookie,
            get: getCookie
        }
    })();

    var runPrefixMethod = function(element, method) {
        var usablePrefixMethod;
        ["webkit", "moz", "ms", "o", ""].forEach(function(prefix) {
            if (usablePrefixMethod) return;
            if (prefix === "") {
                method = method.slice(0,1).toLowerCase() + 	method.slice(1);
            }

            var typePrefixMethod = typeof element[prefix + method];

            if (typePrefixMethod + "" !== "undefined") {
                if (typePrefixMethod === "function") {
                    usablePrefixMethod = element[prefix + method]();
                } else {
                    usablePrefixMethod = element[prefix + method];
                }
            }
        });

        return usablePrefixMethod;
    };

    (function (Cookie,runPrefixMethod) {
        var step = 0;
        var isLoaded = false;
        var lastSum = 0;

        var mv = new MusicVisualizer({
            size: 128,
            visualizer: function (arr) {
                if(step === 3) return;
                var sum = arr.reduce(function (prevResult, item) {
                    return prevResult + item;
                });
                if (sum > 5000) {
                    if(lastSum - sum > 500){
                        $('.j-wrapper-block-main').css({
                            'transform': 'scale(0.5)'
                        });

                        lastSum = sum;
                    }
                    else if(sum - lastSum > 200){
                        $('.j-wrapper-block-main').css({
                            'transform': 'scale(' + (0.5 + 2*(sum - lastSum) / 10000) + ')'
                        });
                        lastSum= sum;
                    }
                }
                else {
                    $('.j-wrapper-block-main').css({
                        'transform': 'scale(0.5)'
                    });
                    lastSum = sum;
                }
            }
        });
        mv.play('static/res/Routine.mp3',function () {
            isLoaded = true;
            if(step > 0){
                mv.start();
            }
        });

        if(!Cookie.get('finished')){
            var welComeText = document.getElementsByClassName('j-welcome-text');
            [].forEach.call(welComeText,function (item) {
                item.classList.add('play');
            });

            setTimeout(function () {
                var _removeFlagStr = isLoaded ? 'fail' : 'success';
                [].forEach.call(welComeText, function (item) {
                    if (item.classList.contains(_removeFlagStr)) {
                        item.remove();
                    }
                });
            },8000);
            //welcome-box-center
            setTimeout(function () {
                document.getElementsByClassName('j-welcome-box-center')[0].classList.add('die');
                setTimeout(function () {
                    document.getElementsByClassName('j-welcome-box-center')[0].remove();
                    document.getElementsByClassName('j-welcome-box-btn')[0].classList.remove('hide');
                    document.getElementsByClassName('j-welcome-box-btn')[0].classList.add('show');
                },1800);
            },11000);
        }
        else {
            document.getElementsByClassName('j-welcome-box-center')[0].remove();
            document.getElementsByClassName('j-welcome-box-btn')[0].classList.remove('hide');
            document.getElementsByClassName('j-welcome-box-btn')[0].classList.add('show');
        }

        document.getElementsByClassName('j-welcome-box-btn')[0].addEventListener('click',function () {
            if(!Cookie.get('finished')){
                Cookie.set('finished','1',1);
            }
            runPrefixMethod(document.documentElement, "RequestFullScreen");
            step2();
            step2 = null;
        });

        function step2() {
            step = 1;

            if(isLoaded){
                mv.start();
            }

            document.getElementsByClassName('j-welcome-block')[0].classList.add('fadeout');
            makeSky.init(function (far) {
                if (step === 1 && far > 200) {
                    step = 2;
                    $('.j-wrapper-block-main').css({
                        'z-index': '20'
                    });
                    $('.j-stage-block-main').css({
                        'transform': 'translate3d(0,0,0)'
                    });
                    $('.j-stage-box-earth').click(function () {
                        step = 3;
                        var $this = $(this);
                        if ($this.hasClass('no')) return;
                        $this.addClass('shake no');
                        var bi = new MakeBreakImg({
                            el: $('.j-stage-img-earth')
                        });
                        makeSky.backToStart(function () {
                            bi.makeBreak();
                            setTimeout(function () {
                                $('.j-wrapper-block-main').remove();
                            }, 1000);
                        });
                    });

                }
            });

            var timeSeed = 0;
            window.onresize = function () {
                timeSeed && clearTimeout(timeSeed);
                timeSeed = setTimeout(function () {
                    makeSky.restart();
                }, 200);
            };

            setTimeout(function () {
                document.getElementsByClassName('j-welcome-block')[0].remove();
            }, 2000);
        }

        document.body.addEventListener("dblclick", function() {
            if (runPrefixMethod(document, "FullScreen") || runPrefixMethod(document, "IsFullScreen")) {
                runPrefixMethod(document, "CancelFullScreen");
            } else {
                runPrefixMethod(document.documentElement, "RequestFullScreen");
            }
        });

    })(Cookie,runPrefixMethod);
</script>
</body>
</html>